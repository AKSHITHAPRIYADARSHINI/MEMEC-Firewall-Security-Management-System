<style>
  /* Sidebar Collapse Styles */
  .sidenav {
    transition: width 0.3s ease, margin-left 0.3s ease;
    width: 260px;
  }

  .sidenav.collapsed {
    width: 70px;
  }

  .sidenav.collapsed .nav-link-text,
  .sidenav.collapsed .section-label {
    display: none;
  }

  .sidenav.collapsed .navbar-brand span {
    display: none;
  }

  .sidenav.collapsed .navbar-brand {
    justify-content: center;
  }

  .sidenav.collapsed .sidenav-footer .btn {
    padding: 0.5rem !important;
    font-size: 0 !important;
    width: 50px !important;
  }

  .sidenav.collapsed .sidenav-footer .btn::before {
    content: "?";
    font-size: 1rem;
  }

  .navbar-brand {
    display: flex;
    align-items: center;
  }

  .sidebar-toggle-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    margin-bottom: 1rem;
  }

  .sidebar-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .sidebar-toggle-btn i {
    font-size: 1.2rem;
  }

  .section-label {
    display: block;
    font-size: 0.75rem !important;
    font-weight: 700 !important;
    padding: 1rem 1rem 0.5rem !important;
    margin: 0.5rem 0 0 0 !important;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.5px;
  }

  .section-divider {
    margin: 0.5rem 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .nav-link {
    position: relative;
    transition: all 0.2s ease;
  }

  .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.08) !important;
  }

  .nav-link.active {
    background: linear-gradient(195deg, #66bb6a 0%, #58a85c 100%) !important;
    border-radius: 0.5rem;
  }

  .submenu-item {
    padding-left: 2.5rem !important;
    font-size: 0.875rem;
  }

  .submenu-item::before {
    content: "";
    display: inline-block;
    width: 4px;
    height: 4px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    margin-right: 0.5rem;
    margin-left: -0.75rem;
    transition: all 0.2s ease;
  }

  .submenu-item.active::before {
    background: white;
    transform: scale(1.5);
  }

  .collapse-arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    margin-left: auto;
    font-size: 0.8rem;
  }

  .collapse-arrow.collapsed {
    transform: rotate(-90deg);
  }

  .nav-link.collapsed-parent {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sidenav.collapsed .collapse-arrow {
    display: none;
  }

  /* Tooltip for collapsed state */
  .sidenav.collapsed .nav-link {
    position: relative;
  }

  .sidenav.collapsed .nav-link[title]::after {
    content: attr(title);
    position: absolute;
    left: 60px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 1000;
  }

  .sidenav.collapsed .nav-link:hover[title]::after {
    opacity: 1;
  }

  /* Responsive behavior */
  @media (max-width: 991px) {
    .sidenav {
      width: 70px;
      margin-left: -70px;
    }

    .sidenav.show {
      margin-left: 0;
    }

    .sidenav.collapsed {
      width: 70px;
    }
  }

  @media (max-width: 767px) {
    .sidenav {
      position: fixed;
      z-index: 1030;
    }
  }
</style>

<aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 bg-gradient-dark" id="sidenav-main">
  <!-- Header with Logo and Collapse Toggle -->
  <div class="sidenav-header d-flex align-items-center justify-content-between px-3 py-3">
    <a class="navbar-brand m-0 d-flex align-items-center" href="{{ url_for('index') }}">
      <img src="/static/assets/img/logo-ct.png" class="navbar-brand-img h-100" alt="Firewall Dashboard" style="max-width: 35px;">
      <span class="ms-2 font-weight-bold text-white d-none d-md-inline" style="font-size: 0.95rem;">Firewall Security</span>
    </a>
    <button class="sidebar-toggle-btn d-lg-none" id="sidebarToggleBtn" aria-label="Toggle sidebar">
      <i class="material-icons">menu</i>
    </button>
  </div>

  <button class="sidebar-toggle-btn ms-3" id="sidebarCollapseBtn" title="Collapse sidebar" aria-label="Collapse sidebar">
    <i class="material-icons">chevron_left</i>
  </button>

  <hr class="horizontal light mt-2 mb-2">

  <div class="collapse navbar-collapse w-auto max-height-vh-100" id="sidenav-collapse-main">
    <ul class="navbar-nav">
      <!-- Main Dashboard -->
      <li class="nav-item">
        <a class="nav-link text-white {% if 'index' in segment %} active bg-gradient-primary {% endif %}"
           href="/" title="Dashboard">
          <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
            <i class="material-icons opacity-10">dashboard</i>
          </div>
          <span class="nav-link-text ms-1">Dashboard</span>
        </a>
      </li>

      <!-- Administration Section -->
      {% if current_user.is_authenticated and (current_user.is_admin() or current_user.is_lower_admin()) %}
      <div class="section-divider"></div>
      <li class="nav-item">
        <h6 class="section-label">Administration</h6>
      </li>

      <!-- User Management (Admin only) -->
      {% if current_user.is_admin() %}
      <li class="nav-item">
        <a class="nav-link text-white {% if 'admin' in segment and 'user' in segment %} active bg-gradient-primary {% endif %}"
           href="{{ url_for('authentication_blueprint.admin_users_list') }}" title="User Management">
          <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
            <i class="material-icons opacity-10">group</i>
          </div>
          <span class="nav-link-text ms-1">User Management</span>
        </a>
      </li>
      {% endif %}

      <!-- Firewall Management (Collapsible) -->
      <li class="nav-item">
        <a class="nav-link text-white collapsed-parent {% if 'firewall' in segment %} active bg-gradient-primary {% endif %}"
           data-bs-toggle="collapse" href="#firewallMenu" role="button"
           aria-expanded="{% if 'firewall' in segment %}true{% else %}false{% endif %}"
           aria-controls="firewallMenu" title="Firewall Management">
          <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
            <i class="material-icons opacity-10">security</i>
          </div>
          <span class="nav-link-text ms-1">Firewall Management</span>
          <span class="collapse-arrow {% if 'firewall' not in segment %}collapsed{% endif %}">
            <i class="material-icons" style="font-size: 1rem;">expand_more</i>
          </span>
        </a>
        <div class="collapse {% if 'firewall' in segment %}show{% endif %}" id="firewallMenu">
          <ul class="navbar-nav ms-2">
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'dashboard' in segment and 'firewall' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.dashboard') }}" title="Firewall Dashboard">
                <span class="nav-link-text">Dashboard</span>
              </a>
            </li>
            {% if current_user.is_admin() %}
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'config' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.config') }}" title="Configuration">
                <span class="nav-link-text">Configuration</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'access-control' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.access_control') }}" title="Access Control">
                <span class="nav-link-text">Access Control</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'policies' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.policies') }}" title="Policies">
                <span class="nav-link-text">Policies</span>
              </a>
            </li>
            {% endif %}
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'audit-logs' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.audit_logs') }}" title="Audit Logs">
                <span class="nav-link-text">Audit Logs</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'statistics' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.statistics') }}" title="Statistics">
                <span class="nav-link-text">Statistics</span>
              </a>
            </li>
            {% if current_user.is_lower_admin() %}
            <li class="nav-item">
              <a class="nav-link text-white submenu-item {% if 'risk-dashboard' in segment %} active {% endif %}"
                 href="{{ url_for('firewall_blueprint.risk_dashboard') }}" title="Risk Dashboard">
                <span class="nav-link-text">Risk Dashboard</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </div>
      </li>
      {% endif %}

      <!-- Account Section -->
      <div class="section-divider"></div>
      <li class="nav-item">
        <h6 class="section-label">Account</h6>
      </li>

      <li class="nav-item">
        <a class="nav-link text-white {% if 'profile' in segment %} active bg-gradient-primary {% endif %}"
           href="/profile.html" title="Profile">
          <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
            <i class="material-icons opacity-10">person</i>
          </div>
          <span class="nav-link-text ms-1">Profile</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link text-white" href="{{ url_for('authentication_blueprint.logout') }}" title="Logout">
          <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
            <i class="material-icons opacity-10">logout</i>
          </div>
          <span class="nav-link-text ms-1">Logout</span>
        </a>
      </li>
    </ul>
  </div>
</aside>

<script>
  // Sidebar collapse/expand functionality
  (function() {
    const sidebar = document.getElementById('sidenav-main');
    const collapseBtn = document.getElementById('sidebarCollapseBtn');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const storageKey = 'sidebarCollapsed';

    // Initialize sidebar state from localStorage
    function initializeSidebar() {
      const isCollapsed = localStorage.getItem(storageKey) === 'true';
      if (isCollapsed) {
        sidebar.classList.add('collapsed');
        updateArrowsState();
      }
    }

    // Toggle sidebar collapse
    function toggleSidebar() {
      const isCollapsed = sidebar.classList.toggle('collapsed');
      localStorage.setItem(storageKey, isCollapsed);
      updateArrowsState();
    }

    // Update arrow rotation states
    function updateArrowsState() {
      const arrows = document.querySelectorAll('.collapse-arrow');
      const isCollapsed = sidebar.classList.contains('collapsed');
      arrows.forEach(arrow => {
        const parentLink = arrow.closest('.nav-link');
        const menu = parentLink?.nextElementSibling;
        if (menu && menu.classList.contains('collapse')) {
          const isMenuOpen = menu.classList.contains('show');
          if (isCollapsed || !isMenuOpen) {
            arrow.classList.add('collapsed');
          } else {
            arrow.classList.remove('collapsed');
          }
        }
      });
    }

    // Listen to submenu toggle
    document.addEventListener('show.bs.collapse', function(e) {
      if (e.target.id === 'firewallMenu') {
        const arrow = document.querySelector('.collapse-arrow');
        if (arrow) {
          arrow.classList.remove('collapsed');
        }
      }
    });

    document.addEventListener('hide.bs.collapse', function(e) {
      if (e.target.id === 'firewallMenu') {
        const arrow = document.querySelector('.collapse-arrow');
        if (arrow) {
          arrow.classList.add('collapsed');
        }
      }
    });

    // Event listeners
    if (collapseBtn) {
      collapseBtn.addEventListener('click', toggleSidebar);
    }

    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('show');
      });
    }

    // Initialize on page load
    initializeSidebar();

    // Handle window resize for responsive behavior
    window.addEventListener('resize', function() {
      if (window.innerWidth > 991) {
        sidebar.classList.remove('show');
      }
    });
  })();
</script>
  