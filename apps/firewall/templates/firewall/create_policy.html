{% extends "layouts/base.html" %}

{% block title %}Create Firewall Policy{% endblock %}

{% set page_title = "Create Firewall Policy" %}
{% set breadcrumbs = [
  {"title": "Administration", "url": None},
  {"title": "Firewall Management", "url": url_for('firewall_blueprint.dashboard')},
  {"title": "Policies", "url": url_for('firewall_blueprint.policies')},
  {"title": "Create Policy", "url": None}
] %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Create New Firewall Policy</h6>
          <p class="text-sm text-secondary">Define a new firewall rule for inbound or outbound traffic</p>
        </div>
        <div class="card-body">
          <!-- Alerts -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <form method="post" action="{{ url_for('firewall_blueprint.create_policy') }}">
            {{ form.csrf_token }}

            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label class="form-label">Policy Name *</label>
                  {{ form.policy_name(class="form-control", placeholder="e.g., Allow Web Traffic") }}
                  {% if form.policy_name.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.policy_name.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Rule Type *</label>
                  {{ form.rule_type(class="form-select") }}
                  <small class="text-muted d-block mt-2">
                    <strong>Inbound:</strong> Incoming traffic to your network<br>
                    <strong>Outbound:</strong> Outgoing traffic from your network
                  </small>
                  {% if form.rule_type.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.rule_type.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Protocol *</label>
                  {{ form.protocol(class="form-select") }}
                  {% if form.protocol.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.protocol.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Port Range *</label>
                  {{ form.port_range(class="form-control", placeholder="e.g., 80 or 80-443 or 1024:65535") }}
                  <small class="text-muted d-block mt-2">
                    Single port: <code>80</code><br>
                    Port range: <code>80-443</code><br>
                    Multiple ports: <code>22,80,443</code>
                  </small>
                  {% if form.port_range.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.port_range.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Action *</label>
                  {{ form.action(class="form-select") }}
                  <small class="text-muted d-block mt-2">
                    <strong>Allow:</strong> Permit this traffic<br>
                    <strong>Deny:</strong> Block this traffic
                  </small>
                  {% if form.action.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.action.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Source IP (Optional)</label>
                  {{ form.source_ip(class="form-control", placeholder="192.168.1.0/24 or 10.0.0.50") }}
                  <small class="text-muted d-block mt-2">CIDR notation or specific IP address</small>
                  {% if form.source_ip.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.source_ip.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Destination IP (Optional)</label>
                  {{ form.destination_ip(class="form-control", placeholder="10.0.0.0/8 or 192.168.1.100") }}
                  <small class="text-muted d-block mt-2">CIDR notation or specific IP address</small>
                  {% if form.destination_ip.errors %}
                    <div class="alert alert-danger mt-2">
                      {% for error in form.destination_ip.errors %}
                        <small>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Priority *</label>
              {{ form.priority(class="form-control", placeholder="Lower number = higher priority (default: 100)") }}
              <small class="text-muted d-block mt-2">
                Rules with lower priority numbers are evaluated first. Example: Priority 1 is evaluated before Priority 100.
              </small>
              {% if form.priority.errors %}
                <div class="alert alert-danger mt-2">
                  {% for error in form.priority.errors %}
                    <small>{{ error }}</small><br>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="alert alert-info">
              <h6>Policy Tips</h6>
              <ul class="mb-0">
                <li>Start with a low priority number for critical policies</li>
                <li>Use CIDR notation for network ranges (e.g., 192.168.0.0/24)</li>
                <li>Leave IP fields empty to apply to all sources/destinations</li>
                <li>All new policies are created in an active state</li>
              </ul>
            </div>

            <div class="d-flex gap-2 pt-3 border-top">
              <button type="submit" name="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Create Policy
              </button>
              <a href="{{ url_for('firewall_blueprint.policies') }}" class="btn btn-secondary">
                Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  code {
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Monaco', monospace;
    font-size: 12px;
  }
</style>
{% endblock %}
