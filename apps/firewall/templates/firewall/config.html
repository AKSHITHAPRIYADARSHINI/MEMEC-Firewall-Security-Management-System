{% extends "layouts/base.html" %}

{% block title %}Firewall Configuration{% endblock %}

{% set page_title = "Firewall Configuration" %}
{% set breadcrumbs = [
  {"title": "Administration", "url": None},
  {"title": "Firewall Management", "url": url_for('firewall_blueprint.dashboard')},
  {"title": "Configuration", "url": None}
] %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6>Firewall Configuration</h6>
              <p class="text-sm text-secondary mb-0">Configure your firewall type and network settings</p>
            </div>
            <span class="badge bg-{{ 'success' if fw_config and fw_config.is_active else 'secondary' }}">
              {{ 'Active' if fw_config and fw_config.is_active else 'Inactive' }}
            </span>
          </div>
        </div>
        <div class="card-body">
          <!-- Alerts -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          {% if fw_config %}
          <div class="alert alert-info mb-4">
            <small>Last modified: <strong>{{ fw_config.modified_at.strftime('%Y-%m-%d %H:%M:%S') }}</strong></small>
          </div>
          {% endif %}

          <!-- Configuration Form -->
          <form method="post" action="{{ url_for('firewall_blueprint.config') }}">
            {{ form.csrf_token }}

            <div class="mb-4">
              <label class="form-label"><strong>Firewall Type</strong></label>
              {{ form.firewall_type(class="form-select form-select-lg") }}
              <small class="text-muted d-block mt-2">
                <strong>Host-Based:</strong> Installed on individual systems<br>
                <strong>Network-Based:</strong> Protects entire network perimeter<br>
                <strong>Hybrid:</strong> Combination of both approaches
              </small>
            </div>

            <div class="mb-4">
              <label class="form-label"><strong>Network Ranges (CIDR Notation)</strong></label>
              {{ form.network_ranges(class="form-control", rows="6") }}
              <small class="text-muted d-block mt-2">
                Enter network ranges in CIDR notation (one per line).<br>
                Example: 192.168.0.0/24, 10.0.0.0/8, 172.16.0.0/12
              </small>
              {% if form.network_ranges.errors %}
                <div class="alert alert-danger mt-2">
                  {% for error in form.network_ranges.errors %}
                    <small>{{ error }}</small><br>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="mb-4">
              <label class="form-label"><strong>System-Specific Rules (Optional)</strong></label>
              {{ form.system_configs(class="form-control", rows="6") }}
              <small class="text-muted d-block mt-2">
                Optional: Define system-specific configurations in JSON format.<br>
                Example: {"server1": {"rules": []}, "workstation1": {"rules": []}}
              </small>
              {% if form.system_configs.errors %}
                <div class="alert alert-danger mt-2">
                  {% for error in form.system_configs.errors %}
                    <small>{{ error }}</small><br>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="d-flex gap-2 pt-3 border-top">
              <button type="submit" name="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Save Configuration
              </button>
              <a href="{{ url_for('firewall_blueprint.dashboard') }}" class="btn btn-secondary">
                Back to Dashboard
              </a>
            </div>
          </form>

          <!-- Info Panel -->
          {% if fw_config %}
          <div class="row mt-5 pt-4 border-top">
            <div class="col-md-6">
              <h6>Current Configuration</h6>
              <table class="table table-sm">
                <tr>
                  <td><strong>Type:</strong></td>
                  <td>{{ fw_config.firewall_type.replace('_', ' ').title() }}</td>
                </tr>
                <tr>
                  <td><strong>Status:</strong></td>
                  <td>
                    <span class="badge bg-{{ 'success' if fw_config.is_active else 'warning' }}">
                      {{ 'Active' if fw_config.is_active else 'Inactive' }}
                    </span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Network Ranges:</strong></td>
                  <td><code>{{ fw_config.network_ranges.split('\n') | length }} ranges configured</code></td>
                </tr>
              </table>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  code {
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Monaco', monospace;
  }
</style>
{% endblock %}
