{% extends "layouts/base.html" %}

{% block title %}Audit Logs{% endblock %}

{% set page_title = "Audit Logs" %}
{% set breadcrumbs = [
  {"title": "Administration", "url": None},
  {"title": "Firewall Management", "url": url_for('firewall_blueprint.dashboard')},
  {"title": "Audit Logs", "url": None}
] %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6>Audit Logs</h6>
              <p class="text-sm text-secondary">Comprehensive audit trail of all firewall activities</p>
            </div>
            <span class="badge bg-primary">{{ logs.total }} total events</span>
          </div>
        </div>
        <div class="card-body">
          <!-- Filter -->
          <form method="get" action="{{ url_for('firewall_blueprint.audit_logs') }}" class="mb-4">
            <div class="row">
              <div class="col-md-4">
                <label class="form-label">Filter by Event Type</label>
                <select name="event_type" class="form-select" onchange="this.form.submit()">
                  <option value="">All Events</option>
                  <option value="config_change" {% if event_type == 'config_change' %}selected{% endif %}>Configuration Changes</option>
                  <option value="policy_change" {% if event_type == 'policy_change' %}selected{% endif %}>Policy Changes</option>
                  <option value="access_change" {% if event_type == 'access_change' %}selected{% endif %}>Access Changes</option>
                  <option value="unauthorized_access" {% if event_type == 'unauthorized_access' %}selected{% endif %}>Unauthorized Access</option>
                  <option value="system_event" {% if event_type == 'system_event' %}selected{% endif %}>System Events</option>
                </select>
              </div>
            </div>
          </form>

          <!-- Audit Logs Table -->
          {% if logs.items %}
            <div class="table-responsive">
              <table class="table align-items-center mb-0">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">Event</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">Description</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">Admin</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">IP Address</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">Risk Level</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs.items %}
                  <tr>
                    <td class="ps-4">
                      <span class="badge bg-{{ 'warning' if log.event_type == 'config_change' else 'info' if log.event_type == 'policy_change' else 'secondary' if log.event_type == 'access_change' else 'danger' }}">
                        {{ log.event_type.replace('_', ' ').title() }}
                      </span>
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0">{{ log.event_description }}</p>
                      {% if log.device_info %}
                        <p class="text-sm text-muted mb-0"><small>Device: {{ log.device_info }}</small></p>
                      {% endif %}
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0">
                        {% if log.user %}
                          {{ log.user.username }}
                        {% else %}
                          System
                        {% endif %}
                      </p>
                    </td>
                    <td>
                      <code class="text-sm">{{ log.ip_address or '-' }}</code>
                    </td>
                    <td>
                      <span class="badge bg-{{ 'success' if log.risk_level == 'low' else 'warning' if log.risk_level == 'medium' else 'danger' }}">
                        {{ log.risk_level.upper() }}
                      </span>
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            {% if logs.pages > 1 %}
            <nav class="mt-4">
              <ul class="pagination justify-content-center">
                {% if logs.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('firewall_blueprint.audit_logs', page=logs.prev_num, event_type=event_type) }}">
                    <i class="fas fa-chevron-left"></i> Previous
                  </a>
                </li>
                {% endif %}

                {% for page_num in logs.iter_pages() %}
                  {% if page_num %}
                    <li class="page-item {{ 'active' if page_num == logs.page else '' }}">
                      <a class="page-link" href="{{ url_for('firewall_blueprint.audit_logs', page=page_num, event_type=event_type) }}">
                        {{ page_num }}
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}

                {% if logs.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('firewall_blueprint.audit_logs', page=logs.next_num, event_type=event_type) }}">
                    Next <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          {% else %}
            <div class="text-center py-4">
              <i class="material-icons opacity-10" style="font-size: 48px;">history</i>
              <p class="text-muted mt-3">No audit logs found.</p>
              <small class="text-secondary">Audit logs will appear here when firewall changes are made.</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  code {
    background-color: #f5f5f5;
    padding: 4px 8px;
    border-radius: 3px;
    font-family: 'Monaco', monospace;
    font-size: 12px;
  }
</style>
{% endblock %}
